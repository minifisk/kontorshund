<body onload="hide_completed_payment_button()">


<h1>Betala för annons "{{ title }}" med Swish</h1>

<p>Genom att klicka på knappen nedan, öppnas en QR kod för en Swish betalning om <b>{{ price }}.</b> </p>
<p>Öppna Swish-appen i din telefon, välj QR-kod och rikta kameran mot QR-koden och utför betalningen.</p>
<p>När du godkänt betalningen i din telefon, skickas du automatiskt till den publicerade annonsen.</p>
<p>OBS. Varje QR kod kan endast användas en gång, slutar den att fungera är det bara trycka på knappen igen.</p>
<button id="generate-qr">Generera Swish-QR-kod </button>
<br>
<button id="open-swish">Öppna Swish app på denna enhet</button>

<br>
<br>
<img id="captchaImg" />
<br>
<button id="completed-payment">Jag har betalt </button>
<p id="payment-status"></p>
<a href="{% url 'ad-detail' pk %}" id="go-to-ad">Gå till din annons </a>



  <script>


      // window.location = "swish://paymentrequest?token=" + PaymentRequestToken + "&callbackurl="/din/callback/url"


      ///////////////////////////
      /* "PAYMENT-DONE" BUTTON */
      ///////////////////////////

      // Hiding/unhiding button
      function hide_completed_payment_button() {
        const completed_payment = document.getElementById('completed-payment');
        const go_to_ad_button = document.getElementById('go-to-ad')
        go_to_ad_button.style.display = 'none';
        completed_payment.style.display = 'none';
      }

      function show_completed_payment_button() {
        const completed_payment = document.getElementById('completed-payment');
        const go_to_ad_button = document.getElementById('go-to-ad')
        go_to_ad_button.style.display = 'none';
        completed_payment.style.display = 'block';
      }
      
        // Creating the request
        const completed_payment_button = document.getElementById('completed-payment');
        const status_field = document.getElementById('payment-status')
        const go_to_ad_button = document.getElementById('go-to-ad')


        completed_payment_button.addEventListener('click', (event) => {

          // CSRF Set-up
          let cookie = document.cookie
          let csrftoken = cookie.substring(cookie.indexOf('=') + 1)

          var xhr_complete = new XMLHttpRequest();
          
          xhr_complete.onload = function () {
            if (xhr_complete.readyState === xhr_complete.DONE) {
                if (xhr_complete.status === 200) {
                 
                  status_field.innerHTML = 'Annonsen är betald!'
                  status_field.style.color = 'green'
                  go_to_ad_button.style.display = 'block';

                 
                } 
                else {
                  status_field.innerHTML = 'Annonsen är INTE betald, dubbelkolla så att betalningen gått igenom i din Swish-app! Problem? Maila oss på <a href="mailto:info@kontorshund.se">info@kontorshund.se</a> '
                }
            }
          };
          xhr_complete.open('POST',  "{% url 'swish_payment_status' pk %}", true);
          xhr_complete.setRequestHeader("X-CSRFToken", csrftoken); 
          xhr_complete.setRequestHeader("Content-Type", "text/plain;charset=UTF-8"); 
          xhr_complete.send();

        });
        



      /////////////////////////
      /* GENERATING QR CODE */
      ////////////////////////

      if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        console.log("testing")
        const open_swish_button = document.getElementById('open-swish');

        open_swish_button.addEventListener('click', (event) => {

            // CSRF Set-up
            let cookie = document.cookie
            let csrftoken = cookie.substring(cookie.indexOf('=') + 1)

            var xhr_token = new XMLHttpRequest();

            xhr_token.onload = function () {
              if (xhr_token.readyState === xhr_token.DONE) {
                  if (xhr_token.status === 201) {
                    var response = JSON.parse(xhr_token.response)
                    var token = response['token']
                    //var pk = '{{ pk }}'
                    var callback_url = response['callback_url']
                    window.location = `swish://paymentrequest?token=${token}&callbackurl=${callback_url}}`
                    //window.location = `swish://paymentrequest?token=${token}&callbackurl=merchant%253A%252F%252F`;


                  }
              }
            };
            xhr_token.open('POST',  "{% url 'swish_request_token' pk %}", true);
            xhr_token.setRequestHeader("X-CSRFToken", csrftoken); 
            xhr_token.setRequestHeader("Content-Type", "text/plain;charset=UTF-8"); 
            xhr_token.send();

          });

      }

      const submit_button = document.getElementById('generate-qr');
      submit_button.addEventListener('click', (event) => {

        // CSRF Set-up
        let cookie = document.cookie
        let csrftoken = cookie.substring(cookie.indexOf('=') + 1)

        var xhr_qr = new XMLHttpRequest();
        xhr_qr.responseType = "arraybuffer";
        
        xhr_qr.onload = function () {
          if (xhr_qr.readyState === xhr_qr.DONE) {
              if (xhr_qr.status === 200) {
                
                // Generate QR-Code and display on site
                document.getElementById("captchaImg").setAttribute('src', 'data:image/png;base64,' + btoa(String.fromCharCode.apply(null, new Uint8Array(xhr_qr.response))));

                // Display button - "I have completed payment"
                show_completed_payment_button()

              }
          }
        };
        xhr_qr.open('POST',  "{% url 'swish_payment_qr_code' pk %}", true);
        xhr_qr.setRequestHeader("X-CSRFToken", csrftoken); 
        xhr_qr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8"); 
        xhr_qr.send();

      });


  </script>
