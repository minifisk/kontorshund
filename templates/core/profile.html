{% extends '_base.html' %}
{% load crispy_forms_tags %}
{% load static %}



{% block title %}Din profil{% endblock title %}

{% block content %}

  <h1 id="h1_new_ad" class="mb-5 ">Din profil - {{ user.email}}</h1>

  <h3 class="">Dina bevakningar

    {% if news_email_obj.is_active %}
        <span id="heading_subscription_status">
        (Aktiv)
        </span>
        {% else %}
        <span id="heading_subscription_status">
          (Inaktiv)
        </span>
    {% endif %}

  </h3>

  <p class="mb-4">Här kan du skapa bevakningar av nya annonser och få ett mail antingen veckovis eller dagligen när det kommit upp nya annonser som matchar dina kriterier. Du kan närsomhelst gå in här och aktivera/inaktivera dina bevakningar.</p>


    
  <form method="post" enctype="multipart/form-data" id="adForm" data-municipalities-url="{% url 'ajax_load_municipalities' %}" data-areas-url="{% url 'ajax_load_areas' %}" novalidate>
    {% csrf_token %}  

    {% crispy form %}

  </form>




  <h3 class="mb-5 mt-5">Dina annonser</h3>


  <h5 class="mb-5"><u>Publicerade</u> annonser ({{ published_ads.count }} st)</h5>

  {% for ad in published_ads %}

    <div class="card mb-5" style="width: 18rem;">
      <h6 class="card-header text-center">
        {% if ad.is_offering_own_dog %}
        Hund erbjudes
        {% else %}
        Hund sökes
        {% endif %}
      </h6>
      <a href="{{ ad_url }}{{ ad.id }}">
        <img class="card-img-top" src=" {{ ad.image1.thumbnail.url }}" alt="published ad">
      </a>
        <div class="card-body">
        <h5 class="card-title">{{ ad.title }}</h5>
        <hp class="card-text">Giltig till {{ ad.deletion_date }}</hp>
        <p id="ad_description_snippet" class="card-text">{{ ad.description }}</p>
        <div id="button-container">
          <a href="{{ ad_url }}{{ ad.id }}" class="btn btn-primary mb-3">Gå till annons</a>
          <br>
          <a href="{% url 'swish_payment_extended_template' ad.id %}"><button class="btn btn-success mb-3">Förläng</button></a>
          <a href="{% url 'ad_update_take' ad.id %}"><button class="btn btn-secondary mb-3">Ändra</button></a>
          <a href="{% url 'delete_ad' ad.id %}"><button class="btn btn-danger mb-3">Ta bort</button></a>
        </div>
      </div>
    </div>

  {% endfor %}

  <h5 class="mb-5 mt-5"><u>Opublicerade</u> annonser ({{ unpublished_ads.count }} st) </h5>

  {% for ad in unpublished_ads %}


  <div class="card mb-5" style="width: 18rem;">
    <h6 class="card-header text-center">
      {% if ad.is_offering_own_dog %}
      Hund erbjudes
      {% else %}
      Hund sökes
      {% endif %}
    </h6>
    <a href="{{ ad_url }}{{ ad.id }}">
      <img class="card-img-top" src=" {{ ad.image1.thumbnail.url }}" alt="published ad">
    </a>
    <div class="card-body">
      <h5 class="card-title">{{ ad.title }}</h5>
      <hp class="card-text">Giltig till {{ ad.deletion_date }}</hp>
      <p id="ad_description_snippet" class="card-text">{{ ad.description }}</p>
      <div id="button-container">
          <a href="{{ ad_url }}{{ ad.id }}" class="btn btn-primary mb-3">Gå till annons</a>
          <br>
          <a href="{% url 'swish_payment_initial_template' ad.id %}"><button class="btn btn-success mb-3">Betala</button></a>
          <a href="{% url 'ad_update_take' ad.id %}"><button class="btn btn-secondary mb-3">Ändra</button></a>
          <a href="{% url 'delete_ad' ad.id %}"><button class="btn btn-danger mb-3 ">Ta bort</button></a>
      </div>
    </div>
  </div>

  {% endfor %}


  <h5 class="mb-5 mt-5"><u>Borttagna</u> annonser ({{ deleted_ads.count }} st) </h5>

  {% for ad in deleted_ads %}


  <div class="card mb-5" style="width: 18rem;">
    <h6 class="card-header text-center">
      {% if ad.is_offering_own_dog %}
      Hund erbjudes
      {% else %}
      Hund sökes
      {% endif %}
    </h6>
    <a href="{{ ad_url }}{{ ad.id }}">
      <img class="card-img-top" src=" {{ ad.image1.thumbnail.url }}" alt="deleted ad">
    </a>
    <div class="card-body">
      <h5 class="card-title">{{ ad.title }}</h5>
      <p id="ad_description_snippet" class="card-text">{{ ad.description }}</p>
      <div id="button-container">
          <a href="{{ ad_url }}{{ ad.id }}" class="btn btn-primary mb-3">Gå till annons</a>
          <br>
          <a href="{% url 'swish_payment_extended_template' ad.id %}"><button class="btn btn-success mb-3">Förläng</button></a>
          <a href="{% url 'ad_update_take' ad.id %}"><button class="btn btn-secondary mb-3">Ändra</button></a>
      </div>
    </div>
  </div>

  {% endfor %}


<h4>Ta bort din profil</h4>
<a href="{% url 'deactivate_account' %}"><button class="btn btn-danger mb-3">Ta bort din profil</button></a>




{% endblock content %}


{% block footer %}

<!-- Area selectors -->
<script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
  <script>
      function hide_area_field() {
        const area_selector = document.getElementById('id_area');
        area_selector.style.display = 'none';
      }

  </script>


<script type="text/javascript" charset="utf-8"> 

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
  

  const cancel_subscription_button = document.getElementById('cancel-subscription-button');


  cancel_subscription_button.addEventListener("click", function(e) {
      e.preventDefault();
      console.log("test")


      var xhr_cancel_subscription = new XMLHttpRequest();

      const csrftoken = getCookie('csrftoken');
          
      xhr_cancel_subscription.onload = function () {

        if (xhr_cancel_subscription.readyState === xhr_cancel_subscription.DONE) {
            if (xhr_cancel_subscription.status === 200) {
                
                if (xhr_cancel_subscription.response.includes("Activated")) {
                  const cancel_subscription_button = document.getElementById('cancel-subscription-button');
                  const heading_subscription_status = document.getElementById('heading_subscription_status');
                  cancel_subscription_button.innerHTML = "Inaktivera"
                  cancel_subscription_button.classList.remove('btn-success')
                  cancel_subscription_button.classList.add('btn-danger')
                  heading_subscription_status.innerHTML = "(Aktiv)"
                }
                if (xhr_cancel_subscription.response.includes("Deactivated")) {
                  const cancel_subscription_button = document.getElementById('cancel-subscription-button');
                  const heading_subscription_status = document.getElementById('heading_subscription_status');
                  cancel_subscription_button.innerHTML = "Aktivera"
                  cancel_subscription_button.classList.remove('btn-danger')
                  cancel_subscription_button.classList.add('btn-success')
                  heading_subscription_status.innerHTML = "(Inaktiv)"
                  
                }
            } 
        }
      };
      xhr_cancel_subscription.open('POST',  "{% url 'handle_email_subscription_status' news_email_obj.uuid %}", true);
      xhr_cancel_subscription.setRequestHeader("X-CSRFToken", csrftoken); 
      xhr_cancel_subscription.setRequestHeader("mode", 'same-origin'); 
      xhr_cancel_subscription.send();

    });



    /* Function for handling the province -> municipality dropdown dependencies */

    $(function(){ 
        // inspect html to check id of category select dropdown.
        $(document).on('change', "select#id_province", function(){ 
            $.getJSON("/ajax/load-municipalities/",{province: $(this).val()}, function(j){ 
                 var options = '<option value="">---------</option>'; 
                 for (var i = 0; i < j.length; i++) { 
                  options += '<option value="' + j[i].id + '">' + j[i].name + ' (' + j[i].count + ')' + '</option>'; 
                } 
                 // inspect html to check id of subcategory select dropdown.
                 $("select#id_municipality").html(options); 
 

             }); 
         }); 
     }); 


    /* Function for handling the municipality -> areas dropdown dependencies */
    
    $(function(){ 
        // inspect html to check id of category select dropdown.
        $(document).on('change', "select#id_municipality", function(){ 
            $.getJSON("/ajax/load-areas/",{municipality: $(this).val()}, function(j){ 
                  var options = ''; 
                  for (var i = 0; i < j.length; i++) { 
                    options += '<option value="' + j[i].id + '">' + j[i].name + ' (' + j[i].count + ')' + '</option>'; 
                  } 
                  // inspect html to check id of subcategory select dropdown.
                  $("select#id_areas").html(options); 
              }); 
          }); 
      }); 


  </script>
     
{% endblock footer %}

